
<table id="wrappertable">
	<tr>
	<td id="toolbar">
		<div id="title">TimeInBoxes</div>
		<% if notice %>
		  <p class="alert alert-success"><%= notice %> <span onClick="hideAlert()" id="hide-alert-btn">x</span></p>
		<% end %>
		<% if alert %>
		  <p class="alert alert-danger"><%= alert %></p>
		<% end %>

		<div id="userstatus">
			<p class="navbar-text pull-right">
			<% if user_signed_in? %>
			  <strong><%= current_user.email %></strong>. <br/>
			  <%= link_to 'Edit profile', edit_user_registration_path, :class => 'navbar-link' %> |
			  <%= link_to "Logout", destroy_user_session_path, method: :delete, :class => 'navbar-link'  %>
			<% else %>
			  <%= link_to "Sign up", new_user_registration_path, :class => 'navbar-link'  %> |
			  <%= link_to "Login", new_user_session_path, :class => 'navbar-link'  %>
			<% end %>
			</p>
		</div>

		<div id="todolistwrapper">
			<table id="boxtitleWrapper">
				<tr><td><h2 id="boxtitle"> </h2></td>
					<td id="colorPickerBoxTitleWrapper"></td>
					<td id="deleteBoxWrapper"></td>
				</tr>
			</table>
			<ul id="todolist"></ul>
			<div id="addtodowrapper">
				<h3>Add Todo</h3>
				<%= form_for(@todo) do |f| %>	
					<div class="field">
					    <table>
				    		<tr>
				    			<td><%= f.label :name %></td>
					    		<td><%= f.text_field :name %></td>
					    	</tr>
					    </table>
				  	</div>

			  		<div class="field">
				    	<table>
				    		<tr>
				    			<td><%= f.label :time %></td>
				    			<td><%= f.number_field :time, :value => "0", :class => "dial" %></td>
				    		</tr>
				    	</table>
				  	</div>

				  	<%= f.hidden_field :box_id, :value => "" %>
				  	<div class="actions">
				    	<input type="submit" onclick="createTodo()" value="Create Todo"></div>
				 	</div>
				<% end %>
			</div>
			<div id="addboxwrapper">
				<h3>Add Box</h3>
				<%= form_for(@box) do |f| %>
				  <div class="field">
				    <table>
				    		<tr>
				    			<td><%= f.label :name %></td>
				    			<td><%= f.text_field :name %></td>
					    	</tr>
					    </table>
				  </div>
				  <div class="field">
				    <table>
				    		<tr>
				    			<td><%= f.label :color %></td>
				    			<td><div id="colorPicker">
							        <a class="color"><div class="colorInner"></div></a>
							        <div class="track" style="background-image:url(../images/text-color.png)"></div>
							        <ul class="dropdown"><li></li></ul>
							        <input id="box_color" name="box[color]" class="colorInput" type="hidden">
							    </div></td>
					    	</tr>
					    </table>
				  </div>

				  <input id="box_pos_x" name="box[pos_x]" type="hidden" value="0">
				  <input id="box_pos_y" name="box[pos_y]" type="hidden" value="0">

				  <div class="actions">
				    <input type="submit" onclick="createBox()" value="Create Box"></div>
				  </div>
				<% end %>
			</div>
		</div>
	</td>

	<td style="vertical-align: top;">
		<div id="boxeswrapper">
			<div class="gridster">
				<ul></ul>
			</div>
		</div>
	</td>
	</tr>
</table>


<script>
	var gridster;
	var todos;
	var draggedBoxId;
	
	$(document).ready(function() {
		$(function() {
		    $( "#todolist" ).selectable();
	  	});

	  	$(function() {
		    $( "#box_start_date" ).datepicker();
	  	});

        $(".dial").knob({
        	'min' : 0, 
        	'max' : 240,
        	'width' : 50,
        	'height': 50,
        	'step' : 5,
        	'cursor' : false,
        	'inputColor' : "#FFFFFF",
        	'thickness' : 0.3,
        	 "fgColor":"#EED169"
        });

	  	$("#colorPicker").tinycolorpicker();
	});


    $(function(){

      	gridster = $(".gridster > ul").gridster({
         	widget_margins: [5, 5],
      		widget_base_dimensions: [40, 40],
      		serialize_params:
      			function ($w, wgd) {
			    return {
			      id: $w.prop('id'),
			      col: wgd.col,
			      row: wgd.row
			    };
  			},
      		draggable: {
      			start: function(e, ui) {
      					draggedBoxId = e.toElement.id;
  						draggedBoxId = draggedBoxId.replace("box_", "");
	      				console.log("start: " + draggedBoxId);
				},
	      		stop: function(e, ui) {
	      				console.log("stop: " + draggedBoxId);
						updateBoxPosition(e, ui, draggedBoxId);
				},
			}
      }).data('gridster');
      	var widgets = [
      		<% Box.where(user_id: current_user.id).each do |box| %>
          		["<li id='box_<%=box.id%>'style='background:<%=box.color%>; line-height: <%=((@box_time[box.id] <= 480)? 1 : (@box_time[box.id] / 480.0).to_i) * 40 + 10%>px;' onClick='getTodosForBox(<%=box.id%>, \"<%=box.name%>\", \"<%=box.color%>\")'><%=@box_time[box.id]%></li>", <%=(@box_time[box.id] / 480.0).to_i%>, <%=(@box_time[box.id] / 480.0).to_i%>, <%=box.pos_x%>, <%=box.pos_y%>],	
          	<% end %>
      	];

	  	$.each(widgets, function(i, widget){
	      	gridster.add_widget.apply(gridster, widget)
	  	});

    });

	/**
		Show every related todo is list
	*/
    function getTodosForBox(id, name, color) {
    	$(".gridster li").removeClass("gridster-box-selected");
    	$("#box_" + id).addClass("gridster-box-selected");
    	$.ajax({
		  url: "/boxes/"+id+"/todos",
		  cache: false
		})
		  .done(function( html ) {
		  	var colorpickerForm = "<%= j form_tag('/boxes/', method: 'put', :id => 'colorPickerBoxTitleForm') do %> <% end %>";
		  	var colorpickerDiv = "<div id='colorPicker'>" +
							        "<a class='color'><div class='colorInner'></div></a>" +
							        "<div class='track' style='background-image:url(../images/text-color.png)'></div>" + 
							        "<ul class='dropdown'><li></li></ul>" + 
							        "<input id='box_color' name='box[color]' class='colorInput' type='hidden'>" + 
							    "</div>";
		  				
		  	$("#boxtitle").html(name);
		  	$("#deleteBoxWrapper").html("<a data-confirm='Are you sure?' style='float:right; cursor:pointer;' onclick='deleteBox("+ id + ")'>X</a>");
		  	$("#colorPickerBoxTitleWrapper").html(colorpickerForm);
		  	$("#colorPickerBoxTitleForm").append(colorpickerDiv);
		    $("#todolist").html(html);
		    $("#todo_box_id").val(id)
		    $("#addtodowrapper").show();
		    $("#colorPicker").tinycolorpicker();
		    $("#colorPickerBoxTitleWrapper .colorInner").css("backgroundColor", color);
		    $("#colorPickerBoxTitleWrapper .colorInput").val(color);

		    var $box = $('#colorPickerBoxTitleWrapper #colorPicker');
		    $box.tinycolorpicker();

		    $box.bind("change", function()
		    {
		        // update Box
		        $.ajax({
				  type: "PUT",
				  url: "/boxes/"+id,
				  data: $("#colorPickerBoxTitleForm").serializeArray(),
				  dataType: "script"
				});
		    });

		  });
    }

    function hideAlert() {
    	$(".alert").hide();
    }

    function createTodo() {
    	$("#new_todo").submit(function() {
    		$.ajax({
			  type: "POST",
			  url: "/todos",
			  data: $("#new_todo").serializeArray(),
			})
			.done(function( html ) {
				$("#todolist").html(html);
				$("#todo_name").val("");
				$("#todo_time").val("0");
			});

			$("#new_todo").unbind();
			return false;
		});	
    }

    function createBox() {
    	$("#new_box").submit(function() {
    		$.ajax({
			  type: "POST",
			  url: "/boxes",
			  data: $("#new_box").serializeArray(),
			  dataType: "script"
			})
			.done(function( html ) {
				$("#box_name").val("");
				$("#boxtitle").html("");
				$("#todolist").html("");
				$("#deleteBoxWrapper").html("");
				$("#colorPickerBoxTitleWrapper").html("");
				$("#addtodowrapper").hide();
			});

			$("#new_todo").unbind();
			return false;
		});
    }

    function deleteBox(id) {
		$.ajax({
				  type: "DELETE",
				  url: "/boxes/" + id,
				  dataType: "script"
				})
		.done(function( html ) {
			$("#boxtitle").html("");
			$("#deleteBoxWrapper").html("");
			$("#colorPickerBoxTitleWrapper").html("");
			$("#addtodowrapper").hide();
		});
		return false;
	}


	function updateBoxPosition(e, ui, id) {
		// save new position
		$.ajax({
		  type: "PUT",
		  url: "/boxes/updateBoxes",
		  data: {data: gridster.serialize()},
		  dataType: "script"
		})
		.done(function( html ) {
			
		});
	}
</script>